    <!-- Removed duplicate V1.0 marker from footer -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TDM Classification and Masking JSON Viewer</title>
  <style>
    body {
      font-family: 'Segoe UI', Arial, sans-serif;
      background: #f5f5f5;
      margin: 0;
      padding: 0;
    }
    .header {
  display: flex;
  align-items: center;
  justify-content: center;
  background: #c00;
  color: #fff;
  padding: 28px 32px 22px 32px;
  border-bottom: 4px solid #a00;
  position: relative;
    }
    .header-logo {
  height: 60px;
  margin-right: 18px;
    }
    .header-title {
  font-size: 2em;
  font-weight: 700;
  letter-spacing: 1px;
  flex: 0 1 auto;
    }
    .container {
      max-width: 1100px;
      margin: 32px auto;
      background: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 12px rgba(200,0,0,0.10);
      padding: 32px;
    }
    .filters {
      display: flex;
      gap: 16px;
      margin-bottom: 24px;
      justify-content: center;
    }
    .filters select, .filters input {
      padding: 8px;
      border-radius: 4px;
      border: 1px solid #c00;
      min-width: 160px;
      background: #fff5f5;
      color: #900;
    }
    .filters select:focus, .filters input:focus {
      outline: 2px solid #c00;
    }
    .table-list {
      margin-bottom: 24px;
    }
    .table-card {
      background: #fff5f5;
      border-radius: 6px;
      margin-bottom: 20px;
      padding: 18px 24px;
      box-shadow: 0 1px 4px rgba(200,0,0,0.08);
      border-left: 6px solid #c00;
    }
    .table-title {
      font-size: 1.2em;
      font-weight: 600;
      margin-bottom: 10px;
      color: #c00;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 8px;
    }
    th, td {
      padding: 8px 12px;
      text-align: left;
    }
    th {
      background: #ffe5e5;
      font-weight: 500;
      color: #900;
      border-bottom: 2px solid #c00;
    }
    tr:nth-child(even) {
      background: #fff0f0;
    }
    .classification {
      font-weight: 600;
      color: #c00;
    }
    .pagination {
      text-align: center;
      margin-top: 16px;
    }
    .pagination button {
      padding: 8px 16px;
      margin: 0 4px;
      border: none;
      border-radius: 4px;
      background: #c00;
      color: #fff;
      cursor: pointer;
      font-weight: 500;
      transition: background 0.2s;
    }
    .pagination button:disabled {
      background: #ccc;
      cursor: not-allowed;
    }
    .pagination button:not(:disabled):hover {
      background: #a00;
    }
    @media (max-width: 700px) {
      .container { padding: 12px; }
      .table-card { padding: 10px; }
      .header { flex-direction: column; align-items: flex-start; padding: 12px; }
      .header-title { font-size: 1.3em; }
    }
  </style>
</head>
<body>
  <div class="header">
    <!-- Logo removed as requested -->
    <span class="header-title" style="margin:0 auto;">TDM Classification and Masking JSON Viewer</span>
    <div style="position:absolute;right:18px;top:18px;display:flex;align-items:center;gap:16px;z-index:1001;">
      <span style="font-size:1.1em;color:#fff;opacity:0.8;font-weight:600;letter-spacing:1px;">V1.0</span>
      <button id="howToUseBtn" title="How to Use Guide" style="background:none;border:none;cursor:pointer;padding:0;margin:0;">
        <svg width="28" height="28" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
          <circle cx="12" cy="12" r="12" fill="#fff" opacity="0.85"/>
          <circle cx="12" cy="12" r="10" fill="#c00" opacity="0.9"/>
          <text x="12" y="16" text-anchor="middle" fill="#fff" font-size="15" font-family="Segoe UI, Arial, sans-serif" font-weight="bold">?</text>
        </svg>
      </button>
    </div>
    <footer style="position:fixed;right:18px;bottom:38px;font-size:1.2em;color:#c00;opacity:0.5;font-weight:700;letter-spacing:1px;pointer-events:none;z-index:999;background:transparent;">Beta Dev Usage</footer>
  </div>
  <div class="container">
    <div class="tab-bar" style="display:flex; gap:2px; margin-bottom:24px; border-bottom:2px solid #c00;">
      <button id="tabClassification" class="tab-btn active" style="flex:1; padding:12px; background:#c00; color:#fff; border:none; font-weight:600; cursor:pointer;">Classification</button>
      <button id="tabMasking" class="tab-btn" style="flex:1; padding:12px; background:#fff; color:#c00; border:none; font-weight:600; cursor:pointer;">Masking Map</button>
      <button id="tabSettings" class="tab-btn" style="flex:1; padding:12px; background:#fff; color:#c00; border:none; font-weight:600; cursor:pointer;">JSON Upload</button>
    </div>
    <div id="tabContentClassification">
      <div style="display:flex;justify-content:center;align-items:center;gap:18px;margin-bottom:12px;">
        <label for="classificationSwitch" style="font-weight:600;color:#c00;">Show:</label>
        <select id="classificationSwitch" style="padding:8px;border-radius:4px;border:1px solid #c00;background:#fff5f5;color:#900;min-width:220px;">
          <option value="all">All Tables</option>
          <option value="with">Tables With Classification</option>
          <option value="without">Tables Without Classification</option>
        </select>
        <input type="text" id="classificationTableSearch" placeholder="Search Table Name..." style="padding:8px;border-radius:4px;border:1px solid #c00;min-width:180px;">
      </div>
      <div class="filters" style="display:none;" id="filters">
        <div style="display:flex;flex-direction:column;align-items:flex-start;gap:6px;">
          <label for="tableFilter" style="font-weight:500;color:#c00;">Table Filter:</label>
          <select id="tableFilter">
            <option value="">All Tables</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-start;gap:6px;">
          <label for="typeFilter" style="font-weight:500;color:#c00;">Classification Type Filter:</label>
          <select id="typeFilter">
            <option value="">All Classification Types</option>
          </select>
        </div>
      </div>
      <div id="classificationNote" style="text-align:center; color:#c00; font-size:0.95em; margin-bottom:12px; margin-top:2px;">Filters from the Table Perspective</div>
      <div id="tableList" class="table-list"></div>
      <div class="pagination" id="pagination"></div>
    </div>
    <div id="tabContentMasking" style="display:none;">
      <div style="display:flex;justify-content:center;align-items:center;gap:18px;margin-bottom:12px;">
        <label for="maskingSwitch" style="font-weight:600;color:#c00;">Show:</label>
        <select id="maskingSwitch" style="padding:8px;border-radius:4px;border:1px solid #c00;background:#fff5f5;color:#900;min-width:220px;">
          <option value="all">All Tables</option>
          <option value="with">Tables With Masking Dataset</option>
          <option value="without">Tables Without Masking Dataset</option>
        </select>
        <input type="text" id="maskingTableSearch" placeholder="Search Table Name..." style="padding:8px;border-radius:4px;border:1px solid #c00;min-width:180px;">
      </div>
      <div class="filters" id="maskingFilters" style="display:none; margin-bottom:24px;">
        <div style="display:flex;flex-direction:column;align-items:flex-start;gap:6px;">
          <label for="maskingTableFilter" style="font-weight:500;color:#c00;">Table Filter:</label>
          <select id="maskingTableFilter">
            <option value="">All Tables</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-start;gap:6px;">
          <label for="maskingDatasetFilter" style="font-weight:500;color:#c00;">Masking Dataset Filter:</label>
          <select id="maskingDatasetFilter">
            <option value="">All Masking Datasets</option>
          </select>
        </div>
        <div style="display:flex;flex-direction:column;align-items:flex-start;gap:6px;">
          <label for="maskingDeterministicFilter" style="font-weight:500;color:#c00;">Deterministic Filter:</label>
          <select id="maskingDeterministicFilter">
            <option value="">All</option>
            <option value="true">Yes</option>
            <option value="false">No</option>
          </select>
        </div>
      </div>
      <div id="maskingNote" style="text-align:center; color:#c00; font-size:0.95em; margin-bottom:12px; margin-top:2px;">Filters from the Table Perspective</div>
      <div id="maskingMapContent"></div>
    </div>
    <div id="tabContentSettings" style="display:none;">
      <div style="text-align:center; margin-top:40px;">
        <div id="alreadyUploadedMsg" style="display:none;margin-bottom:24px;color:#090;background:#e6ffe6;padding:16px 18px;border-radius:8px;font-size:1.08em;font-weight:500;"></div>
        <div style="margin-bottom:24px;">
          <div style="margin-bottom:18px;color:#333;background:#fffbe6;padding:14px 18px;border-radius:8px;font-size:1.08em;">
            <b>Instructions:</b> Please upload the <b>classification.json</b> and <b>masking.json</b> files generated by the TDM CLI tool.<br>
            Once both files are uploaded, you can explore and filter your data in the Classification and Masking Map tabs above.
          </div>
          <label for="jsonFile" style="font-weight:600;color:#c00;">Select classification.json: </label>
          <input type="file" id="jsonFile" accept="application/json">
        </div>
        <div>
          <label for="maskingFile" style="font-weight:600;color:#c00;">Select masking.json: </label>
          <input type="file" id="maskingFile" accept="application/json">
        </div>
      </div>
    </div>
    <div id="howToUseModal" style="display:none;position:fixed;top:0;left:0;width:100vw;height:100vh;background:rgba(0,0,0,0.35);z-index:2000;align-items:center;justify-content:center;">
      <div style="background:#fff;border-radius:12px;max-width:520px;padding:36px 32px;box-shadow:0 2px 18px rgba(200,0,0,0.18);margin:auto;position:relative;">
        <button id="closeHowToUse" style="position:absolute;top:12px;right:18px;font-size:1.5em;background:none;border:none;color:#c00;cursor:pointer;font-weight:700;">&times;</button>
        <h2 style="color:#c00;margin-top:0;margin-bottom:18px;font-size:1.35em;">How to Use This Viewer</h2>
        <ul style="color:#333;font-size:1.12em;line-height:1.8;margin-bottom:0;padding-left:22px;">
          <li><b>Upload Files:</b> Use the <b>JSON Upload</b> tab to upload your <code>classification.json</code> and <code>masking.json</code> files.</li>
          <li><b>Explore Tabs:</b> Switch between <b>Classification</b> and <b>Masking Map</b> tabs to view and filter your data.</li>
          <li><b>Filter & Search:</b> Use the filtering options and search boxes to narrow down tables and columns. The <b>Show</b> switch lets you quickly view all tables, only those with classification/masking, or only those without.</li>
          <li><b>Session Persistence:</b> Uploaded files are remembered until you close the browser.</li>
        </ul>
      </div>
    </div>
  </div>
    <!-- Removed duplicate V1.0 marker from footer -->
  <script>
        // How to Use Guide modal logic
        document.addEventListener('DOMContentLoaded', function() {
          var howToUseBtn = document.getElementById('howToUseBtn');
          var howToUseModal = document.getElementById('howToUseModal');
          var closeHowToUse = document.getElementById('closeHowToUse');
          if (howToUseBtn && howToUseModal && closeHowToUse) {
            howToUseBtn.onclick = function() {
              howToUseModal.style.display = 'flex';
            };
            closeHowToUse.onclick = function() {
              howToUseModal.style.display = 'none';
            };
            howToUseModal.onclick = function(e) {
              if (e.target === howToUseModal) howToUseModal.style.display = 'none';
            };
          }
        });
    let data = null;
    let tables = [];
    let tableNames = [];
    let typeList = [];
    const tablesPerPage = 5;
    let currentPage = 1;
    let maskingData = null;
    let maskingTables = [];

    // Load from sessionStorage if available
    window.addEventListener('DOMContentLoaded', function() {
        // Show persistent message in JSON Upload tab if files are already uploaded
        setTimeout(function() {
          const alreadyUploadedMsg = document.getElementById('alreadyUploadedMsg');
          if (alreadyUploadedMsg) {
            const savedClassification = sessionStorage.getItem('classificationJson');
            const savedMasking = sessionStorage.getItem('maskingJson');
            let msg = '';
            if (savedClassification && savedMasking) {
              msg = 'Both <b>classification.json</b> and <b>masking.json</b> are already uploaded and loaded.<br><span style="color:#333;">You can explore your data in the Classification and Masking Map tabs above.</span>';
              alreadyUploadedMsg.style.display = '';
            } else if (savedClassification) {
              msg = '<b>classification.json</b> is already uploaded and loaded.';
              alreadyUploadedMsg.style.display = '';
            } else if (savedMasking) {
              msg = '<b>masking.json</b> is already uploaded and loaded.';
              alreadyUploadedMsg.style.display = '';
            } else {
              alreadyUploadedMsg.style.display = 'none';
            }
            alreadyUploadedMsg.innerHTML = msg;
          }
        }, 0);
      const savedClassification = sessionStorage.getItem('classificationJson');
      const savedMasking = sessionStorage.getItem('maskingJson');
      let hasClassification = false;
      let hasMasking = false;
      if (savedClassification) {
        try {
          data = JSON.parse(savedClassification);
          tables = data.tables || [];
          extractFilters();
          populateFilters();
          showFilters();
          setupFilterEvents();
          currentPage = 1;
          renderTables();
          hasClassification = true;
        } catch (err) {
          sessionStorage.removeItem('classificationJson');
        }
      }
      if (savedMasking) {
        try {
          maskingData = JSON.parse(savedMasking);
          maskingTables = maskingData.tables || [];
          renderMaskingMap();
          hasMasking = true;
        } catch (err) {
          sessionStorage.removeItem('maskingJson');
        }
      }
      // Set default tab: JSON Upload if no files, else Classification
      if (!hasClassification && !hasMasking) {
        setActiveTab('settings');
      } else {
        setActiveTab('classification');
      }
    });

    // Tab logic
    const tabClassification = document.getElementById('tabClassification');
    const tabMasking = document.getElementById('tabMasking');
    const tabSettings = document.getElementById('tabSettings');
    const tabContentClassification = document.getElementById('tabContentClassification');
    const tabContentMasking = document.getElementById('tabContentMasking');
    const tabContentSettings = document.getElementById('tabContentSettings');

    function setActiveTab(tab) {
      tabClassification.classList.remove('active');
      tabMasking.classList.remove('active');
      tabSettings.classList.remove('active');
      tabClassification.style.background = '#fff';
      tabClassification.style.color = '#c00';
      tabMasking.style.background = '#fff';
      tabMasking.style.color = '#c00';
      tabSettings.style.background = '#fff';
      tabSettings.style.color = '#c00';
      tabContentClassification.style.display = 'none';
      tabContentMasking.style.display = 'none';
      tabContentSettings.style.display = 'none';
      if (tab === 'classification') {
        tabClassification.classList.add('active');
        tabClassification.style.background = '#c00';
        tabClassification.style.color = '#fff';
        tabContentClassification.style.display = '';
      } else if (tab === 'masking') {
        tabMasking.classList.add('active');
        tabMasking.style.background = '#c00';
        tabMasking.style.color = '#fff';
        tabContentMasking.style.display = '';
      } else if (tab === 'settings') {
        tabSettings.classList.add('active');
        tabSettings.style.background = '#c00';
        tabSettings.style.color = '#fff';
        tabContentSettings.style.display = '';
      }
    }

    tabClassification.onclick = function() { setActiveTab('classification'); };
    tabMasking.onclick = function() { setActiveTab('masking'); };
    tabSettings.onclick = function() { setActiveTab('settings'); };

    // Set default tab
    // Default tab is now set in DOMContentLoaded based on file presence

    function extractFilters() {
      tableNames = tables.map(t => t.name);
      const typeSet = new Set();
      tables.forEach(t => t.columns.forEach(c => { if (c.type) typeSet.add(c.type); }));
      typeList = Array.from(typeSet).sort();
    }

    function populateFilters() {
      const tableFilter = document.getElementById('tableFilter');
      tableFilter.innerHTML = '<option value="">All Tables</option>';
      tableNames.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        tableFilter.appendChild(opt);
      });
      const typeFilter = document.getElementById('typeFilter');
      typeFilter.innerHTML = '<option value="">All Classification Types</option>';
      typeList.forEach(type => {
        const opt = document.createElement('option');
        opt.value = type;
        opt.textContent = type;
        typeFilter.appendChild(opt);
      });
    }

    function getFilteredTables() {
      const tableVal = document.getElementById('tableFilter').value.trim();
      const tableSearchVal = document.getElementById('classificationTableSearch')?.value.trim().toLowerCase() || '';
      const typeVal = document.getElementById('typeFilter').value.trim();
      const switchVal = document.getElementById('classificationSwitch')?.value || 'all';
      return tables
        .map(table => {
          // Table name search
          if (tableSearchVal && !table.name.toLowerCase().includes(tableSearchVal)) return null;
          // Switch logic
          const hasClassification = table.columns.some(col => col.type && col.type.trim() !== '');
          if (switchVal === 'with' && !hasClassification) return null;
          if (switchVal === 'without' && hasClassification) return null;
          if (tableVal && table.name !== tableVal) return null;
          // If type filter, filter columns
          let filteredColumns = table.columns;
          if (typeVal) {
            filteredColumns = filteredColumns.filter(col => col.type && col.type === typeVal);
          }
          if (filteredColumns.length === 0) return null;
          return { ...table, columns: filteredColumns };
        })
        .filter(Boolean);
    }

    function renderTables() {
      const filteredTables = getFilteredTables();
      const totalPages = Math.ceil(filteredTables.length / tablesPerPage);
      if (currentPage > totalPages) currentPage = totalPages || 1;
      const startIdx = (currentPage - 1) * tablesPerPage;
      const endIdx = startIdx + tablesPerPage;
      const tablesToShow = filteredTables.slice(startIdx, endIdx);
      const tableList = document.getElementById('tableList');
      tableList.innerHTML = '';
      if (!data || !tables || tables.length === 0) {
        tableList.innerHTML = '<div style="text-align:center;color:#c00;font-size:1.15em;margin-top:40px;">No classification.json file loaded.<br>Please upload your classification.json file in the JSON Upload tab.</div>';
        document.getElementById('pagination').innerHTML = '';
        return;
      }
      if (tablesToShow.length === 0) {
        tableList.innerHTML = '<p style="text-align:center;color:#888;">No tables match the filter criteria.</p>';
        document.getElementById('pagination').innerHTML = '';
        return;
      }
      const typeVal = document.getElementById('typeFilter').value.trim();
      tablesToShow.forEach(table => {
        const card = document.createElement('div');
        card.className = 'table-card';
        card.innerHTML = `<div class="table-title">${table.name} <span style="color:#888;font-size:0.9em;">(${table.schema})</span></div>`;
        const tbl = document.createElement('table');
        tbl.innerHTML = `<tr><th>Column</th><th>Classification Type</th><th>Max Length</th></tr>`;
        let columnsToShow = table.columns;
        if (typeVal) {
          columnsToShow = columnsToShow.filter(col => col.type && col.type === typeVal);
        }
        columnsToShow.forEach(col => {
          tbl.innerHTML += `<tr>
            <td>${col.name}</td>
            <td class="classification">${col.type ? col.type : '<span style=\"color:#bbb;\">-</span>'}</td>
            <td>${col.maxLength !== undefined ? col.maxLength : ''}</td>
          </tr>`;
        });
        card.appendChild(tbl);
        tableList.appendChild(card);
      });
      // Pagination controls
      const pagination = document.getElementById('pagination');
      pagination.innerHTML = '';
      if (totalPages > 1) {
        for (let i = 1; i <= totalPages; i++) {
          const btn = document.createElement('button');
          btn.textContent = i;
          btn.disabled = (i === currentPage);
          btn.onclick = () => { currentPage = i; renderTables(); };
          pagination.appendChild(btn);
        }
      }
    }

    function showFilters() {
      document.getElementById('filters').style.display = '';
      document.getElementById('classificationSwitch').style.display = '';
    }

    function setupFilterEvents() {
      document.getElementById('tableFilter').onchange =
      document.getElementById('typeFilter').onchange =
      document.getElementById('classificationSwitch').onchange = function() {
        const switchVal = document.getElementById('classificationSwitch').value;
        if (switchVal === 'with' || switchVal === 'without') {
          document.getElementById('tableFilter').value = '';
          document.getElementById('typeFilter').value = '';
        }
        currentPage = 1;
        renderTables();
      };
      document.getElementById('classificationTableSearch').oninput = function() {
        currentPage = 1;
        renderTables();
      };
    }

    document.getElementById('jsonFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          data = JSON.parse(evt.target.result);
        } catch (err) {
          alert('The file is not valid JSON. Please upload a valid classification.json file.');
          return;
        }
        if (!data || !Array.isArray(data.tables)) {
          alert('The file is missing required structure. Expected a "tables" array in the root object.');
          return;
        }
        tables = data.tables;
        extractFilters();
        populateFilters();
        showFilters();
        setupFilterEvents();
        currentPage = 1;
        renderTables();
        // Save to sessionStorage
        sessionStorage.setItem('classificationJson', evt.target.result);
        showUploadSuccess('classification');
      };
      reader.readAsText(file);
    });

    document.getElementById('maskingFile').addEventListener('change', function(e) {
      const file = e.target.files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = function(evt) {
        try {
          maskingData = JSON.parse(evt.target.result);
          maskingTables = maskingData.tables || [];
          renderMaskingMap();
          // Save to sessionStorage
          sessionStorage.setItem('maskingJson', evt.target.result);
          showUploadSuccess('masking');
        } catch (err) {
          alert('Invalid masking.json file.');
        }
      };
      // Show upload success message and navigation prompt
      function showUploadSuccess(type) {
        const tabContentSettings = document.getElementById('tabContentSettings');
        let msg = '<div id="uploadSuccessMsg" style="margin-top:24px;color:#090;background:#e6ffe6;padding:16px 18px;border-radius:8px;font-size:1.08em;font-weight:500;">Successfully uploaded <b>classification.json</b> or <b>masking.json</b>!<br><span style="color:#333;">Once both files are uploaded, you can explore the <b>Classification</b> and <b>Masking Map</b> tabs above.</span></div>';
        // Remove any previous success message
        const prevMsg = document.getElementById('uploadSuccessMsg');
        if (prevMsg) prevMsg.remove();
        tabContentSettings.insertAdjacentHTML('beforeend', msg);
      }
      reader.readAsText(file);
    });

    function populateMaskingFilters() {
      // Use table names from masking.json
      const tableNames = maskingTables.map(t => t.name);
      const datasetSet = new Set();
      maskingTables.forEach(t => t.columns.forEach(c => { if (c.dataset) datasetSet.add(c.dataset); }));
      const datasetList = Array.from(datasetSet).sort();
      const tableFilter = document.getElementById('maskingTableFilter');
      tableFilter.innerHTML = '<option value="">All Tables</option>';
      tableNames.forEach(name => {
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        tableFilter.appendChild(opt);
      });
      const datasetFilter = document.getElementById('maskingDatasetFilter');
      datasetFilter.innerHTML = '<option value="">All Masking Datasets</option>';
      datasetList.forEach(ds => {
        const opt = document.createElement('option');
        opt.value = ds;
        opt.textContent = ds;
        datasetFilter.appendChild(opt);
      });
      document.getElementById('maskingFilters').style.display = '';
    }

    function getFilteredMaskingTables() {
      const tableVal = document.getElementById('maskingTableFilter').value.trim();
      const tableSearchVal = document.getElementById('maskingTableSearch')?.value.trim().toLowerCase() || '';
      const datasetVal = document.getElementById('maskingDatasetFilter').value.trim();
      const deterministicVal = document.getElementById('maskingDeterministicFilter').value;
      const switchVal = document.getElementById('maskingSwitch')?.value || 'all';
      // Filter tables by table name
      let filteredTables = maskingTables;
      if (tableVal) {
        filteredTables = maskingTables.filter(table => table.name === tableVal);
      }
      // For each table, filter columns by masking dataset and deterministic
      filteredTables = filteredTables.map(table => {
        let filteredColumns = table.columns;
        if (datasetVal) {
          filteredColumns = filteredColumns.filter(col => col.dataset === datasetVal);
        }
        if (deterministicVal === 'true') {
          filteredColumns = filteredColumns.filter(col => col.deterministic === true);
        } else if (deterministicVal === 'false') {
          filteredColumns = filteredColumns.filter(col => col.deterministic === false || col.deterministic === undefined);
        }
        return { ...table, columns: filteredColumns };
      });
      // Only return tables that have columns after filtering
      filteredTables = filteredTables.filter(table => table.columns.length > 0);
      // Table name search
      filteredTables = filteredTables.filter(table => {
        if (tableSearchVal && !table.name.toLowerCase().includes(tableSearchVal)) return false;
        return true;
      });
      // Switch logic
      return filteredTables.filter(table => {
        const hasMaskingDataset = table.columns.some(col => col.dataset && col.dataset.trim() !== '');
        if (switchVal === 'with' && !hasMaskingDataset) return false;
        if (switchVal === 'without' && hasMaskingDataset) return false;
        return true;
      });
    }

    function renderMaskingMap() {
      const container = document.getElementById('maskingMapContent');
      if (!maskingData || !maskingTables || maskingTables.length === 0) {
        container.innerHTML = '<div style="text-align:center; color:#c00; font-size:1.15em; margin-top:40px;">No masking.json file loaded.<br>Please upload your masking.json file in the JSON Upload tab.</div>';
        document.getElementById('maskingFilters').style.display = 'none';
        return;
      }
      // Save current filter values before repopulating filters
      const prevTableVal = document.getElementById('maskingTableFilter')?.value || '';
      const prevDatasetVal = document.getElementById('maskingDatasetFilter')?.value || '';
      const prevDeterministicVal = document.getElementById('maskingDeterministicFilter')?.value || '';
      const prevSwitchVal = document.getElementById('maskingSwitch')?.value || 'all';
      const prevTableSearchVal = document.getElementById('maskingTableSearch')?.value || '';
      populateMaskingFilters();
      // Restore previous filter values
      document.getElementById('maskingTableFilter').value = prevTableVal;
      document.getElementById('maskingDatasetFilter').value = prevDatasetVal;
      document.getElementById('maskingDeterministicFilter').value = prevDeterministicVal;
      document.getElementById('maskingSwitch').value = prevSwitchVal;
      document.getElementById('maskingTableSearch').value = prevTableSearchVal;
      // Ensure event listeners are set after filters are populated
      ['maskingTableFilter','maskingDatasetFilter','maskingDeterministicFilter','maskingTableSearch'].forEach(id => {
        const el = document.getElementById(id);
        if (el) {
          el.onchange = el.oninput = function() {
            renderMaskingMap();
          };
        }
      });
      // Special handling for maskingSwitch
      const maskingSwitchEl = document.getElementById('maskingSwitch');
      if (maskingSwitchEl) {
        maskingSwitchEl.onchange = function() {
          const switchVal = maskingSwitchEl.value;
          if (switchVal === 'with' || switchVal === 'without') {
            document.getElementById('maskingTableFilter').value = '';
            document.getElementById('maskingDatasetFilter').value = '';
            document.getElementById('maskingDeterministicFilter').value = '';
          }
          renderMaskingMap();
        };
      }
      const filteredTables = getFilteredMaskingTables();
      let html = '';
      filteredTables.forEach(table => {
        html += `<div class=\"table-card\">`
          + `<div class=\"table-title\">${table.name} <span style=\"color:#888;font-size:0.9em;\">(${table.schema})</span></div>`
          + `<table><tr><th>Column</th><th>Masking Dataset</th><th>Deterministic</th><th>Max Length</th></tr>`;
        table.columns.forEach(col => {
          html += `<tr>`
            + `<td>${col.name}</td>`
            + `<td>${col.dataset ? `<span style='color:#c00;font-weight:600;'>${col.dataset}</span>` : '<span style=\"color:#bbb;\">-</span>'}</td>`
            + `<td>${typeof col.deterministic === 'boolean' ? (col.deterministic ? 'Yes' : 'No') : ''}</td>`
            + `<td>${col.maxLength !== undefined ? col.maxLength : ''}</td>`
            + `</tr>`;
        });
        html += '</table></div>';
      });
      container.innerHTML = html;
    }
  </script>
</body>
</html>